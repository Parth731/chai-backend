Mongoose .pre('save') does not trigger

take care of async and await

what is pipeline 
what is aggregation
what is variable in mongodb


Books

_id:1,
title:"The Great Getsby",
author_id:100,
genre:"Classic"

authors

_id: 100,
name: "F. Scott Fitzgerald,
birth_year: 1896 


books doc  has a reference to authors document using author_id as the foreign key.
[
    {
        $lookup:{
            form:"authors",
            localField:"author_id",
            foreignField:"_id",
            as:"test"
        },

    },
    {
        $addFields:{
            author_details:{
                $first:"$test",
                 $arrayElemAt:["$author_details",0]
            }
        }
    }
]

// exmaple of count subscribers and subscribedTo

export const getUserChannelProfile = asyncHandler(async (req, res) => {
  const { username } = req.params;

  if (!username?.trim()) {
    throw new ApiError(400, "username is missing");
  }

  const channel = await User.aggregate([
    {
      $match: {
        username: username?.toLowerCase(),
      },
    },
    {
      $lookup: {
        from: "subscriptions",
        localField: "_id",
        foreignField: "channel",
        as: "subscribers",
      },
    },
    {
      $lookup: {
        from: "subscriptions",
        localField: "_id",
        foreignField: "subscriber",
        as: "subscribedTo",
      },
    },
    {
      $addFields: {
        subscribersCount: {
          $size: "$subscribers",
        },
        channelsSubscribedToCount: {
          $size: "$subscribedTo",
        },
        isSubscribed: {
          $cond: {
            if: { $in: [req.user?._id, "$subscribers.subscriber"] },
            then: true,
            else: false,
          },
        },
      },
    },
    {
      $project: {
        fullName: 1,
        username: 1,
        subscribersCount: 1,
        channelsSubscribedToCount: 1,
        isSubscribed: 1,
        avatar: 1,
        coverImage: 1,
        email: 1,
      },
    },
  ]);

  console.log(channel);

  if (!channel?.length) {
    throw new ApiError(404, "channel does not exists");
  }

  return res
    .status(200)
    .json(
      new ApiResponse(200, channel[0], "User channel fetched successfully")
    );
});


// understand of subscribers and channel 

subscribers and channel both are one type of user

channel => when selected channel get how many subscribers
subscribers => when selected subscribers get how many channel


what is pipeline?
what is aggregation?

$match
$lookup
$addFields
$projects


// count watch history

